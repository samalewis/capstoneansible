---
- name: Backup EXOS switch primary.cfg and show configuration (Pure Shell)
  hosts: exos_switches
  gather_facts: no
  vars:
    # 1. HOST PATH MAPPING
    backup_dir: "/backups/{{ inventory_hostname }}"

  tasks:
    - name: Get current timestamp on localhost
      ansible.builtin.setup:
        filter: ansible_date_time
      delegate_to: localhost
      register: local_facts

    - name: Set timestamp fact
      ansible.builtin.set_fact:
        timestamp: "{{ local_facts.ansible_facts.ansible_date_time.iso8601_basic_short }}"

    - name: Create backup directory
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0777'
      delegate_to: localhost

    # -----------------------------------------------------------------------
    # TASK 1: SCP THE FILE
    # -----------------------------------------------------------------------
    - name: Pull primary.cfg using SCP
      ansible.builtin.shell: >-
        sshpass -e 
        scp 
        -o HostKeyAlgorithms=+ssh-rsa
        -o PubkeyAcceptedKeyTypes=+ssh-rsa
        -o StrictHostKeyChecking=no
        -o UserKnownHostsFile=/dev/null
        -o LogLevel=ERROR
        admin@{{ ansible_host }}:primary.cfg
        {{ backup_dir }}/primary_{{ timestamp }}.cfg
      environment:
        SSHPASS: "{{ ansible_password }}"
      delegate_to: localhost
      register: scp_result

    - name: Confirm SCP success
      ansible.builtin.debug:
        msg: "primary.cfg saved."
      when: scp_result.rc == 0

    # -----------------------------------------------------------------------
    # TASK 2: SHOW CONFIGURATION
    # Fix: Pipe commands into stdin using printf (Simulates hitting Enter)
    # -----------------------------------------------------------------------
    - name: Run 'show configuration' via SSH
      ansible.builtin.shell: >-
        printf "disable clipaging\nshow configuration\n" | 
        timeout 300 
        sshpass -e 
        ssh -T 
        -o HostKeyAlgorithms=+ssh-rsa 
        -o PubkeyAcceptedKeyTypes=+ssh-rsa 
        -o StrictHostKeyChecking=no 
        -o UserKnownHostsFile=/dev/null 
        -o LogLevel=ERROR 
        admin@{{ ansible_host }}
      environment:
        SSHPASS: "{{ ansible_password }}"
      delegate_to: localhost
      register: show_config_raw

    - name: Save 'show configuration' output
      ansible.builtin.copy:
        content: "{{ show_config_raw.stdout }}"
        dest: "{{ backup_dir }}/show_config_{{ timestamp }}.txt"
      delegate_to: localhost
      when: show_config_raw.rc == 0

    # -----------------------------------------------------------------------
    # TASK 3: SHOW CONFIGURATION DETAIL
    # -----------------------------------------------------------------------
    - name: Run 'show configuration detail' via SSH
      ansible.builtin.shell: >-
        printf "disable clipaging\nshow configuration detail\n" | 
        timeout 300 
        sshpass -e 
        ssh -T 
        -o HostKeyAlgorithms=+ssh-rsa 
        -o PubkeyAcceptedKeyTypes=+ssh-rsa 
        -o StrictHostKeyChecking=no 
        -o UserKnownHostsFile=/dev/null 
        -o LogLevel=ERROR 
        admin@{{ ansible_host }}
      environment:
        SSHPASS: "{{ ansible_password }}"
      delegate_to: localhost
      register: show_detail_raw

    - name: Save 'show configuration detail' output
      ansible.builtin.copy:
        content: "{{ show_detail_raw.stdout }}"
        dest: "{{ backup_dir }}/show_config_detail_{{ timestamp }}.txt"
      delegate_to: localhost
      when: show_detail_raw.rc == 0
