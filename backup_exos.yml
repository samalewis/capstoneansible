
---
- name: Install sshpass if missing (idempotent)
  hosts: localhost
  become: yes
  gather_facts: no
  tasks:
    - name: Ensure sshpass is installed
      ansible.builtin.package:
        name: sshpass
        state: present

- name: Backup EXOS switch primary.cfg via manual SCP and save show configuration
  hosts: exos_switches
  gather_facts: no
  connection: ansible.netcommon.network_cli
  vars:
    ansible_network_os: community.network.exos
    backup_dir: "./backups/{{ inventory_hostname }}"

  tasks:
    - name: Get current timestamp on localhost
      ansible.builtin.setup:
        filter: ansible_date_time
      delegate_to: localhost
      register: local_facts

    - name: Set timestamp fact
      ansible.builtin.set_fact:
        timestamp: "{{ local_facts.ansible_facts.ansible_date_time.iso8601_basic_short }}"

    - name: Create local backup directory
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost

     - name: Pull primary.cfg using SCP with sshpass (fully automated)
      ansible.builtin.command: >-
        sshpass -p '{{ ansible_ssh_password }}'
        scp 
        -o HostKeyAlgorithms=+ssh-rsa
        -o PubkeyAcceptedKeyTypes=+ssh-rsa
        -o StrictHostKeyChecking=no
        -o UserKnownHostsFile=/dev/null
        admin@{{ ansible_host }}:primary.cfg
        {{ backup_dir }}/primary_{{ timestamp }}.cfg
      delegate_to: localhost
      no_log: true
      register: scp_result

    - name: Confirm SCP success
      ansible.builtin.debug:
        msg: "primary.cfg successfully backed up!"
      when: scp_result.rc == 0

    - name: Display SCP output (for troubleshooting)
      ansible.builtin.debug:
        msg: 
          - "Return Code: {{ scp_result.rc }}"
          - "StdOut: {{ scp_result.stdout_lines }}"
          - "StdErr: {{ scp_result.stderr_lines }}"
      when: scp_result is defined and scp_result.rc != 0

    - name: Run 'show configuration' and save output
      community.network.exos_command:
        commands: show configuration
      register: show_config

    - name: Save 'show configuration' output to file
      ansible.builtin.copy:
        content: "{{ show_config.stdout[0] }}"
        dest: "{{ backup_dir }}/show_config_{{ timestamp }}.txt"
      delegate_to: localhost

    - name: Run 'show configuration detail' and save output
      community.network.exos_command:
        commands: show configuration detail
      register: show_config_detail

    - name: Save 'show configuration detail' output to file
      ansible.builtin.copy:
        content: "{{ show_config_detail.stdout[0] }}"
        dest: "{{ backup_dir }}/show_config_detail_{{ timestamp }}.txt"
      delegate_to: localhost
