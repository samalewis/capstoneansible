---
- name: Configure Guest VLAN 40 with VRRP and guestacl.pol on EXOS Cores
  hosts: exos_switches
  gather_facts: false
  collections:
    - extreme.exos.exos

  vars:
    vlan_name: "Guest"
    vlan_tag: 40
    vrrp_vrid: 40
    vrrp_vip: "10.1.40.1"
    policy_file: "guestacl.pol"
    dhcp_relay_servers:
      - "10.1.200.4"
      - "10.1.200.5"
    isc_ports: "2,3,4,5"   # Confirmed from your XML configs

  tasks:

    - name: Create VLAN Guest
      extreme.exos.exos_vlans:
        name: "{{ vlan_name }}"
        vlanid: "{{ vlan_tag }}"
        description: "Guest-VLAN 40"
        state: present

    - name: Add VLAN Guest tagged to ISC/MLAG ports 2-5
      extreme.exos.exos_config:
        lines:
          - "configure vlan {{ vlan_name }} add ports {{ isc_ports }} tagged"

    - name: Configure L3 IP on Core-01A
      extreme.exos.exos_l3_interfaces:
        name: "{{ vlan_name }}"
        ipv4:
          - address: "10.1.40.2/24"
        state: present
      when: inventory_hostname == "Core-01A"

    - name: Configure L3 IP on Core-02A
      extreme.exos.exos_l3_interfaces:
        name: "{{ vlan_name }}"
        ipv4:
          - address: "10.1.40.3/24"
        state: present
      when: inventory_hostname == "Core-02A"

    - name: Create VRRP instance
      extreme.exos.exos_vrrp:
        vlan: "{{ vlan_name }}"
        vrid: "{{ vrrp_vrid }}"
        state: present

    - name: Configure VRRP details on Core-01A (Primary)
      extreme.exos.exos_command:
        commands:
          - "configure vrrp vlan {{ vlan_name }} vrid {{ vrrp_vrid }} vrid-priority 200"
          - "configure vrrp vlan {{ vlan_name }} vrid {{ vrrp_vrid }} advertise-interval 1"
          - "configure vrrp vlan {{ vlan_name }} vrid {{ vrrp_vrid }} accept-mode off"
          - "configure vrrp vlan {{ vlan_name }} vrid {{ vrrp_vrid }} ipaddress {{ vrrp_vip }}"
          - "enable vrrp vlan {{ vlan_name }} vrid {{ vrrp_vrid }}"
      when: inventory_hostname == "Core-01A"

    - name: Configure VRRP details on Core-02A (Backup)
      extreme.exos.exos_command:
        commands:
          - "configure vrrp vlan {{ vlan_name }} vrid {{ vrrp_vrid }} vrid-priority 100"
          - "configure vrrp vlan {{ vlan_name }} vrid {{ vrrp_vrid }} advertise-interval 1"
          - "configure vrrp vlan {{ vlan_name }} vrid {{ vrrp_vrid }} accept-mode off"
          - "configure vrrp vlan {{ vlan_name }} vrid {{ vrrp_vrid }} ipaddress {{ vrrp_vip }}"
          - "enable vrrp vlan {{ vlan_name }} vrid {{ vrrp_vrid }}"
      when: inventory_hostname == "Core-02A"

    - name: Add DHCP relay helpers
      extreme.exos.exos_command:
        commands:
          - "configure vlan {{ vlan_name }} ipaddress dhcp-relay add {{ item }}"
      loop: "{{ dhcp_relay_servers }}"

    - name: Refresh guestacl.pol policy
      extreme.exos.exos_command:
        commands:
          - "refresh policy {{ policy_file }}"

    - name: Apply guestacl.pol ingress on VLAN Guest
      extreme.exos.exos_config:
        lines:
          - "configure access-list {{ policy_file }} vlan {{ vlan_name }} ingress"
        save_when: changed

    - name: Save configuration
      extreme.exos.exos_command:
        commands:
          - "save configuration"
